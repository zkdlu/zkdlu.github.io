---
layout: post
title: "[ELK] 3. ELK와 Kafka로 Log 관제하기"
description: "Elasticsearch, Logstash, Kibana, Kafka"
date: 2021-01-22 00:00:00
tags: [ELK, Docker, Kafka]
comments: true
share: true
---

아직 ELK에 대한 이해가 부족하여 많이 헷갈린다.

우선 서비스들이 Kafka로 로그를 전송하면 ELK로 Kafka의 로그를 수집하는 시나리오로 동작 시켜 보자.



## ELK를 사용해보도록 하자.

### 1. 도커로 만들어진 ELK 를 사용한다.

```bash
$ git clone https://github.com/deviantony/docker-elk.git
```



### 2. Elasticsearch 설정 변경

x-pack은 보안,알림, 모니터링, 보고, 그래프 기능을 편리한 단일 패키지로 제공하는 유료 서비스라고 하니 지우도록 한다.

```yaml
# elasticsearch/config/elasticsearch.yml
cluster.name: "docker-cluster"
network.host: 0.0.0.0
```



### 3. Kibana 설정 변경

elasticsearch에서 제공하는 rest api를 사용하기 위해 서버 주소가 필요한데, 같은 도커 네트워크에서는 컨테이너 명으로 dns가 설정되니 변경하고, 유료 서비스같은거 안 쓸거니까 elasticsearch 패스워드는 지우도록 한다.

```yml
# kibana/config/kibana.yml
server.name: kibana
server.host: 0.0.0.0
elasticsearch.hosts: [ "http://elk_elasticsearch_1:9200" ]
monitoring.ui.container.elasticsearch.enabled: true
```



### 4. Logstash 설정 변경

elasticsearch의 호스트 정보를 변경한다.

```yaml
# logstash/config/logstash.yml
http.host: "0.0.0.0"
xpack.monitoring.elasticsearch.hosts: [ "http://elk_elasticsearch_1:9200" ]
```



### 5. Logstash 파이프라인 변경

카프카로부터 로그 정보를 수집할거기 때문에 input에 kafka, output은 elasticsearch로 한다.

Kibana에서 데이터를 시각화하기 위해서 Elasticsearch의 index에 저장이 되어야 하므로 index를 설정해준다. Kibana에서 index pattern을 wildcard로 처리가 가능하므로 index정보를 일별로 생성 할 수 있도록 한다.

```json
# logstash/pipeline/logstash.conf
input {
	kafka {
		bootstrap_servers => "kafka-container:9092"
		group_id => "logstash"
		topics => ["logs"]
		consumer_threads => 1
	}
}

## Add your filters / logstash plugins configuration here

output {
	elasticsearch {
		hosts => "elk-kafka_elasticsearch_1:9200"
        index => "log-%{+YYYY.MM.dd}"
	}
}
```



### 6. 실행

미리 Kafka에 Topic을 생성해두고 ELK를 실행해보자.

```bash
$ docker-compose build && docker-compose up
```



### 뭐지????

docker가 빌드되고 컨테이너가 실행되면서 로그가 빠르게 출력되다 logstash가 예외를 뱉으며 종료된다.

```bash
logstash_1       | LogStash::Error: Don't know how to handle `Java::JavaLang::IllegalStateException` for `PipelineAction::Create<main>`
logstash_1       |           create at org/logstash/execution/ConvergeResultExt.java:129
logstash_1       |              add at org/logstash/execution/ConvergeResultExt.java:57
logstash_1       |   converge_state at /usr/share/logstash/logstash-core/lib/logstash/agent.rb:378
logstash_1       | [2021-01-22T12:04:44,183][ERROR][logstash.agent           ] An exception happened when converging configuration {:exception=>LogStash::Error, :message=>"Don't know how to handle `Java::JavaLang::IllegalStateException` for `PipelineAction::Create<main>`"}
logstash_1       | [2021-01-22T12:04:44,203][FATAL][logstash.runner          ] An unexpected error occurred! {:error=>#<LogStash::Error: Don't know how to handle `Java::JavaLang::IllegalStateException` for `PipelineAction::Create<main>`>, :backtrace=>["org/logstash/execution/ConvergeResultExt.java:129:in `create'", "org/logstash/execution/ConvergeResultExt.java:57:in `add'", "/usr/share/logstash/logstash-core/lib/logstash/agent.rb:378:in `block in converge_state'"]}
logstash_1       | [2021-01-22T12:04:44,211][ERROR][org.logstash.Logstash    ] java.lang.IllegalStateException: Logstash stopped processing because of an error: (SystemExit) exit
logstash_1       | warning: thread "Api Webserver" terminated with exception (report_on_exception is true):
logstash_1       | NameError: uninitialized constant Rack::Builder
logstash_1       |     const_missing at org/jruby/RubyModule.java:3760
logstash_1       |               app at /usr/share/logstash/logstash-core/lib/logstash/api/rack_app.rb:97
logstash_1       |   start_webserver at /usr/share/logstash/logstash-core/lib/logstash/webserver.rb:99
logstash_1       |               run at /usr/share/logstash/logstash-core/lib/logstash/webserver.rb:60
logstash_1       |              each at org/jruby/RubyRange.java:526
logstash_1       |   each_with_index at org/jruby/RubyEnumerable.java:1258
logstash_1       |               run at /usr/share/logstash/logstash-core/lib/logstash/webserver.rb:55
logstash_1       |   start_webserver at /usr/share/logstash/logstash-core/lib/logstash/agent.rb:424
logstash_1       | Exception in thread "Api Webserver" java.lang.NullPointerException
logstash_1       |      at org.jruby.internal.runtime.ThreadService.getMainThread(ThreadService.java:233)
logstash_1       |      at org.jruby.RubyThread.exceptionRaised(RubyThread.java:1822)
logstash_1       |      at org.jruby.internal.runtime.RubyRunnable.run(RubyRunnable.java:112)
logstash_1       |      at java.base/java.lang.Thread.run(Thread.java:834)
```

왜 그런지 모르겠으나 host주소를 container의 이름으로 pipeline 내부에서 파싱할 수 없나보다.

파이프 라인의 elasticsearch 주소를 변경한다.

```json
# logstash/pipeline/logstash.conf
....
output {
	elasticsearch {
		hosts => "172.29.170.253:9200"
		index => "log-%{+YYYY.MM.dd}"
	}
}
```



### 다시 실행

elk에서 예외가 종료되진 않는다. 그런데 지속적으로 출력되는 예외 메시지가 눈에 보인다.

```bash
Error: Failed to construct kafka consumer
Exception: Java::OrgApacheKafkaCommon::KafkaException
Stack: org.apache.kafka.clients.consumer.KafkaConsumer.<init>(org/apache/kafka/clients/consumer/KafkaConsumer.java:820)
```

곰곰히 생각을 하다 깨달은게 있다.

kafka와 elk는 현재 다른 도커 네트워크에 있기 때문에  컨테이너명으로 host를 쓸 수 없는 것이다.



### 간단하게?

간단하게 해결하는 방법은 network를 하나 생성 후 docker-compose에 설정 하는 것이다.

```yaml
# docker-compose.yml
...
networks:
  default:
    external:
      name: my-network
...
```

당장 연습 예제로는 이 방법으로도 충분하다. 하지만 클라우드 환경에서 개발을 하기엔 제약이 걸리므로 주소를 명시하는 방법으로 해결하겠다.



### Kafka Broker의 주소를 명시해주자.

logstash의 pipeline에 kafka의 broker주소를 명시한 후 다시 실행해본다.

```json
# logstash/pipeline/logstash.conf
input {
	kafka {
		bootstrap_servers => "172.29.170.253:9092"
		group_id => "logstash"
		topics => ["logs"]
		consumer_threads => 1
	}
}
....
```



실행을 하니 이번엔 또 새로운 오류가 보인다.

```bash
[WARN ][org.apache.kafka.clients.NetworkClient][main][15a7e73f9380c35108d8b47ea292cf9dc52e5a47679aab2cd6f22b3ba33a37f7] [Consumer clientId=logstash-0, groupId=logstash] Connection to node -1 (/172.29.170.253:9092) could not be established. Broker may not be available.
[WARN ][org.apache.kafka.clients.NetworkClient][main][15a7e73f9380c35108d8b47ea292cf9dc52e5a47679aab2cd6f22b3ba33a37f7] [Consumer clientId=logstash-0, groupId=logstash] Bootstrap broker 172.29.170.253:9092 (id: -1 rack: null) disconnected
```



